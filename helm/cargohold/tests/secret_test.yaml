suite: Secret tests
templates:
  - templates/secret.yaml
tests:
  - it: creates Secret with default values (redis auth disabled)
    asserts:
      - isKind:
          of: Secret
      - equal:
          path: type
          value: Opaque

  - it: includes required keys (without redis-password when auth disabled)
    asserts:
      - exists:
          path: data["database-password"]
      - notExists:
          path: data["redis-password"]
      - exists:
          path: data["s3-access-key-id"]
      - exists:
          path: data["s3-secret-access-key"]

  - it: includes redis-password when auth enabled
    set:
      redis:
        auth:
          enabled: true
        password: "redis-test"
    asserts:
      - exists:
          path: data["database-password"]
      - exists:
          path: data["redis-password"]
      - exists:
          path: data["s3-access-key-id"]
      - exists:
          path: data["s3-secret-access-key"]

  - it: does not create Secret when all components use existingSecret
    set:
      postgres:
        existingSecret: postgres-secret
      redis:
        auth:
          enabled: true
        existingSecret: redis-secret
      s3:
        existingSecret: s3-secret
    asserts:
      - hasDocuments:
          count: 0

  - it: does not create Secret when postgres and s3 use existingSecret (redis auth disabled)
    set:
      postgres:
        existingSecret: postgres-secret
      s3:
        existingSecret: s3-secret
    asserts:
      - hasDocuments:
          count: 0

  - it: creates Secret with only non-existingSecret components
    set:
      postgres:
        password: "test-password"
      redis:
        auth:
          enabled: true
        existingSecret: redis-secret
      s3:
        existingSecret: s3-secret
    asserts:
      - isKind:
          of: Secret
      - exists:
          path: data["database-password"]
      - notExists:
          path: data["redis-password"]
      - notExists:
          path: data["s3-access-key-id"]

  - it: Base64 encodes passwords
    set:
      postgres:
        password: "test-password"
    asserts:
      - equal:
          path: data["database-password"]
          value: "dGVzdC1wYXNzd29yZA=="

  - it: does not include GitHub OAuth secrets when oauth is disabled (default)
    asserts:
      - notExists:
          path: data["github-oauth-client-id"]
      - notExists:
          path: data["github-oauth-client-secret"]

  - it: includes GitHub OAuth secrets when oauth is enabled
    set:
      oauth:
        github:
          enabled: true
          clientId: "test-client-id"
          clientSecret: "test-client-secret"
    asserts:
      - exists:
          path: data["github-oauth-client-id"]
      - exists:
          path: data["github-oauth-client-secret"]

  - it: Base64 encodes GitHub OAuth credentials
    set:
      oauth:
        github:
          enabled: true
          clientId: "my-client-id"
          clientSecret: "my-client-secret"
    asserts:
      - equal:
          path: data["github-oauth-client-id"]
          value: "bXktY2xpZW50LWlk"
      - equal:
          path: data["github-oauth-client-secret"]
          value: "bXktY2xpZW50LXNlY3JldA=="

  - it: does not include GitHub OAuth secrets when existingSecret is used
    set:
      oauth:
        github:
          enabled: true
          existingSecret: my-github-oauth-secret
    asserts:
      - notExists:
          path: data["github-oauth-client-id"]
      - notExists:
          path: data["github-oauth-client-secret"]
