suite: Deployment tests
templates:
  - templates/deployment.yaml
  - templates/secret.yaml
tests:
  - it: creates Deployment with default values
    template: templates/deployment.yaml
    asserts:
      - isKind:
          of: Deployment
      - equal:
          path: spec.replicas
          value: 2
      - equal:
          path: spec.template.spec.containers[0].image
          value: "cargohold:0.1.0"

  - it: allows setting replicaCount to 0
    template: templates/deployment.yaml
    set:
      deployment:
        replicaCount: 0
    asserts:
      - equal:
          path: spec.replicas
          value: 0

  - it: allows setting replicaCount to 3
    template: templates/deployment.yaml
    set:
      deployment:
        replicaCount: 3
    asserts:
      - equal:
          path: spec.replicas
          value: 3

  - it: allows custom image configuration
    template: templates/deployment.yaml
    set:
      deployment:
        image:
          repository: custom-repo/cargohold
          tag: "v1.0.0"
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: "custom-repo/cargohold:v1.0.0"

  - it: sets security context
    template: templates/deployment.yaml
    asserts:
      - equal:
          path: spec.template.spec.securityContext.runAsNonRoot
          value: true
      - equal:
          path: spec.template.spec.securityContext.runAsUser
          value: 1000
      - equal:
          path: spec.template.spec.containers[0].securityContext.allowPrivilegeEscalation
          value: false
      - equal:
          path: spec.template.spec.containers[0].securityContext.readOnlyRootFilesystem
          value: true

  - it: configures livenessProbe and readinessProbe
    template: templates/deployment.yaml
    asserts:
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.path
          value: /healthz
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.httpGet.path
          value: /readyz

  - it: sets Secret environment variables
    template: templates/deployment.yaml
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: DATABASE_PASSWORD
            valueFrom:
              secretKeyRef:
                name: RELEASE-NAME-cargohold
                key: password

  - it: allows using existingSecret
    template: templates/deployment.yaml
    set:
      postgres:
        existingSecret: my-existing-secret
        existingSecretKey: database-password
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: DATABASE_PASSWORD
            valueFrom:
              secretKeyRef:
                name: my-existing-secret
                key: database-password

  - it: allows adding extraEnv
    template: templates/deployment.yaml
    set:
      extraEnv:
        - name: CUSTOM_VAR
          value: custom-value
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: CUSTOM_VAR
            value: custom-value

  - it: allows setting resource limits
    template: templates/deployment.yaml
    set:
      deployment:
        container:
          resources:
            limits:
              cpu: 500m
              memory: 512Mi
            requests:
              cpu: 100m
              memory: 128Mi
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources.limits.cpu
          value: 500m
      - equal:
          path: spec.template.spec.containers[0].resources.requests.memory
          value: 128Mi

  - it: allows adding extraContainers
    template: templates/deployment.yaml
    set:
      extraContainers:
        - name: cloud-sql-proxy
          image: gcr.io/cloud-sql-connectors/cloud-sql-proxy:2.8.0
          args:
            - "--port=5432"
    asserts:
      - contains:
          path: spec.template.spec.containers
          content:
            name: cloud-sql-proxy
            image: gcr.io/cloud-sql-connectors/cloud-sql-proxy:2.8.0
            args:
              - "--port=5432"

  - it: does not set REDIS_PASSWORD when redis auth is disabled (default)
    template: templates/deployment.yaml
    asserts:
      - notContains:
          path: spec.template.spec.containers[0].env
          content:
            name: REDIS_PASSWORD
          any: true

  - it: sets REDIS_PASSWORD when redis auth is enabled
    template: templates/deployment.yaml
    set:
      redis:
        auth:
          enabled: true
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: REDIS_PASSWORD
            valueFrom:
              secretKeyRef:
                name: RELEASE-NAME-cargohold
                key: password

  - it: uses existingSecret for REDIS_PASSWORD when redis auth is enabled
    template: templates/deployment.yaml
    set:
      redis:
        auth:
          enabled: true
        existingSecret: my-redis-secret
        existingSecretKey: my-redis-password
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: REDIS_PASSWORD
            valueFrom:
              secretKeyRef:
                name: my-redis-secret
                key: my-redis-password

  - it: does not set GitHub OAuth env vars when oauth is disabled (default)
    template: templates/deployment.yaml
    asserts:
      - notContains:
          path: spec.template.spec.containers[0].env
          content:
            name: GITHUB_OAUTH_CLIENT_ID
          any: true
      - notContains:
          path: spec.template.spec.containers[0].env
          content:
            name: GITHUB_OAUTH_CLIENT_SECRET
          any: true

  - it: sets GitHub OAuth env vars when oauth is enabled
    template: templates/deployment.yaml
    set:
      oauth:
        github:
          enabled: true
          existingSecretKeys:
            clientId: "github-oauth-client-id"
            clientSecret: "github-oauth-client-secret"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: GITHUB_OAUTH_CLIENT_ID
            valueFrom:
              secretKeyRef:
                name: RELEASE-NAME-cargohold
                key: github-oauth-client-id
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: GITHUB_OAUTH_CLIENT_SECRET
            valueFrom:
              secretKeyRef:
                name: RELEASE-NAME-cargohold
                key: github-oauth-client-secret

  - it: uses existingSecret for GitHub OAuth when specified
    template: templates/deployment.yaml
    set:
      oauth:
        github:
          enabled: true
          existingSecret: my-github-oauth-secret
          existingSecretKeys:
            clientId: "my-client-id-key"
            clientSecret: "my-client-secret-key"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: GITHUB_OAUTH_CLIENT_ID
            valueFrom:
              secretKeyRef:
                name: my-github-oauth-secret
                key: my-client-id-key
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: GITHUB_OAUTH_CLIENT_SECRET
            valueFrom:
              secretKeyRef:
                name: my-github-oauth-secret
                key: my-client-secret-key
