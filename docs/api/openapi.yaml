openapi: 3.2.0
info:
  title: Cargohold - Git LFS Server API
  summary: Git LFS Batch API を提供する自前実装サーバー
  description: |
    Cargohold は Git LFS (Git Large File Storage) の自前実装サーバーです。

    Git LFS Batch API を提供し、S3互換ストレージ、PostgreSQL、Redis を統合することで、
    スケーラブルで高性能な LFS サーバーを実現します。

    ## 認証方式

    Cargohold は GitHub OIDC 認証をサポートしています：

    - **GitHub OIDC**: CI/CD向け（GitHub Actions からの JWT トークン認証）

    ## 必須HTTPヘッダー

    Git LFS API エンドポイントでは以下のヘッダーが必須です：

    - `Accept: application/vnd.git-lfs+json`
    - `Content-Type: application/vnd.git-lfs+json`
  version: 1.0.0
  contact:
    name: na2na
  license:
    name: MIT
    identifier: MIT

servers:
  - url: http://localhost:8080
    description: ローカル開発環境

tags:
  - name: Batch API
    description: Git LFS Batch API エンドポイント
  - name: Object Proxy
    description: LFSオブジェクトのプロキシエンドポイント
  - name: Verify
    description: アップロード完了通知エンドポイント
  - name: Authentication
    description: 認証関連エンドポイント
  - name: Health
    description: ヘルスチェックエンドポイント

paths:
  /info/lfs/objects/batch:
    post:
      tags:
        - Batch API
      summary: Git LFS Batch API
      description: |
        Git LFS Batch API エンドポイント。

        `upload` または `download` オペレーションを処理し、
        プロキシエンドポイントURLを含むレスポンスを返却します。

        ## 認証

        以下の認証方式を使用：
        - Bearer Token: `Authorization: Bearer <JWT_TOKEN>`（GitHub OIDC）
      operationId: batchObjects
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/vnd.git-lfs+json:
            schema:
              $ref: '#/components/schemas/BatchRequest'
            examples:
              uploadRequest:
                summary: アップロードリクエスト
                value:
                  operation: upload
                  objects:
                    - oid: abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890
                      size: 123456789
                  transfers:
                    - basic
                  ref:
                    name: refs/heads/main
                  hash_algo: sha256
              downloadRequest:
                summary: ダウンロードリクエスト
                value:
                  operation: download
                  objects:
                    - oid: abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890
                      size: 123456789
                  transfers:
                    - basic
      responses:
        '200':
          description: 成功レスポンス
          content:
            application/vnd.git-lfs+json:
              schema:
                $ref: '#/components/schemas/BatchResponse'
              examples:
                uploadResponse:
                  summary: アップロードレスポンス
                  value:
                    transfer: basic
                    objects:
                      - oid: abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890
                        size: 123456789
                        authenticated: true
                        actions:
                          upload:
                            href: "https://cargohold.example.com/owner/repo/info/lfs/objects/abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890"
                            header: {}
                            expires_in: 900
                    hash_algo: sha256
                downloadResponse:
                  summary: ダウンロードレスポンス
                  value:
                    transfer: basic
                    objects:
                      - oid: abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890
                        size: 123456789
                        authenticated: true
                        actions:
                          download:
                            href: "https://cargohold.example.com/owner/repo/info/lfs/objects/abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890"
                            header: {}
                            expires_in: 900
                    hash_algo: sha256
        '400':
          description: 不正なリクエスト（ヘッダー検証エラー）
          content:
            application/vnd.git-lfs+json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                message: "Acceptは application/vnd.git-lfs+json である必要があります"
        '401':
          description: 認証エラー
          headers:
            LFS-Authenticate:
              description: 認証方式を示すヘッダー
              schema:
                type: string
                example: 'Basic realm="Git LFS"'
          content:
            application/vnd.git-lfs+json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                message: "認証に失敗しました"
        '422':
          description: バリデーションエラー
          content:
            application/vnd.git-lfs+json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                message: "不正なオペレーションです"
        '500':
          description: サーバー内部エラー
          content:
            application/vnd.git-lfs+json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                message: "サーバー内部エラーが発生しました"

  /{owner}/{repo}/info/lfs/objects/{oid}:
    put:
      tags:
        - Object Proxy
      summary: LFSオブジェクトのアップロード
      description: |
        プロキシ経由でS3にLFSオブジェクトをアップロードします。

        Batch APIのuploadレスポンスに含まれるhref URLを使用してアクセスします。
        リクエストボディとしてバイナリデータを直接送信します。
      operationId: proxyUpload
      security:
        - bearerAuth: []
      parameters:
        - name: owner
          in: path
          required: true
          schema:
            type: string
          description: リポジトリオーナー名
        - name: repo
          in: path
          required: true
          schema:
            type: string
          description: リポジトリ名
        - name: oid
          in: path
          required: true
          schema:
            type: string
            pattern: '^[a-f0-9]{64}$'
          description: オブジェクトID（SHA256ハッシュ、64文字の16進数）
      requestBody:
        required: true
        content:
          application/octet-stream:
            schema:
              type: string
              format: binary
              description: LFSオブジェクトのバイナリデータ
      responses:
        '200':
          description: アップロード成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: upload successful
        '400':
          description: 不正なリクエスト（OID形式エラー等）
          content:
            application/vnd.git-lfs+json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: 認証エラー
          content:
            application/vnd.git-lfs+json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: オブジェクトが見つからない
          content:
            application/vnd.git-lfs+json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: サーバー内部エラー
          content:
            application/vnd.git-lfs+json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    get:
      tags:
        - Object Proxy
      summary: LFSオブジェクトのダウンロード
      description: |
        プロキシ経由でS3からLFSオブジェクトをダウンロードします。

        Batch APIのdownloadレスポンスに含まれるhref URLを使用してアクセスします。
        レスポンスはバイナリデータとして返却されます。
      operationId: proxyDownload
      security:
        - bearerAuth: []
      parameters:
        - name: owner
          in: path
          required: true
          schema:
            type: string
          description: リポジトリオーナー名
        - name: repo
          in: path
          required: true
          schema:
            type: string
          description: リポジトリ名
        - name: oid
          in: path
          required: true
          schema:
            type: string
            pattern: '^[a-f0-9]{64}$'
          description: オブジェクトID（SHA256ハッシュ、64文字の16進数）
      responses:
        '200':
          description: ダウンロード成功
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
                description: LFSオブジェクトのバイナリデータ
        '400':
          description: 不正なリクエスト（OID形式エラー等）
          content:
            application/vnd.git-lfs+json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: 認証エラー
          content:
            application/vnd.git-lfs+json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: オブジェクトが見つからない
          content:
            application/vnd.git-lfs+json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: サーバー内部エラー
          content:
            application/vnd.git-lfs+json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /info/lfs/objects/verify:
    post:
      tags:
        - Verify
      summary: アップロード完了通知
      description: |
        クライアントからのアップロード完了通知を受け付けます。

        プロキシ経由のアップロード完了後、クライアントは本エンドポイントを呼び出し、
        サーバー側のメタデータ（`uploaded`フラグ）を更新します。
      operationId: verifyUpload
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/vnd.git-lfs+json:
            schema:
              $ref: '#/components/schemas/VerifyRequest'
            example:
              oid: abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890
              size: 123456789
      responses:
        '200':
          description: 検証成功
          content:
            application/vnd.git-lfs+json:
              schema:
                $ref: '#/components/schemas/VerifyResponse'
              example:
                message: success
        '400':
          description: 不正なリクエスト
          content:
            application/vnd.git-lfs+json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                missingOid:
                  summary: OIDが指定されていない
                  value:
                    message: "oidフィールドは必須です"
                invalidSize:
                  summary: 不正なサイズ
                  value:
                    message: "sizeフィールドは正の整数である必要があります"
                invalidOidFormat:
                  summary: OID形式が不正
                  value:
                    message: "OID形式が不正です"
        '404':
          description: オブジェクトが見つからない
          content:
            application/vnd.git-lfs+json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                message: "オブジェクトが見つかりません"
        '422':
          description: サイズ不一致
          content:
            application/vnd.git-lfs+json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                message: "サイズが一致しません"
        '500':
          description: サーバー内部エラー
          content:
            application/vnd.git-lfs+json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /healthz:
    get:
      tags:
        - Health
      summary: Liveness チェック
      description: |
        サービスの稼働状態を確認するための Liveness チェックエンドポイント。

        Kubernetes の Liveness Probe から使用されます。
        アプリケーションプロセスが正常に動作しているかを確認します。
      operationId: livenessCheck
      responses:
        '200':
          description: サービス正常稼働中
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              example:
                status: healthy

  /readyz:
    get:
      tags:
        - Health
      summary: Readiness チェック
      description: |
        アプリケーションがリクエストを受け付ける準備ができているかを確認するエンドポイント。

        Kubernetes の Readiness Probe から使用されます。
        依存サービス（PostgreSQL、Redis、S3）への接続状態を確認します。
      operationId: readinessCheck
      responses:
        '200':
          description: すべての依存サービスが正常
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReadinessResponse'
              example:
                status: ready
                details:
                  - name: postgres
                    healthy: true
                  - name: redis
                    healthy: true
                  - name: s3
                    healthy: true
        '503':
          description: 1つ以上の依存サービスが異常
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReadinessResponse'
              example:
                status: not ready
                details:
                  - name: redis
                    healthy: false
                    error: "connection refused"

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        GitHub OIDC 認証用の Bearer Token。

        GitHub Actions ワークフロー内で取得した JWT トークンを
        `Authorization: Bearer <JWT_TOKEN>` ヘッダーで送信します。

        サーバーは以下を検証します：
        - JWT 署名（GitHub 公開鍵を使用）
        - issuer claim (`https://token.actions.githubusercontent.com`)
        - audience claim (`cargohold`)
        - repository claim（許可されたリポジトリリストと照合）

  schemas:
    BatchRequest:
      type: object
      required:
        - operation
        - objects
      properties:
        operation:
          type: string
          enum:
            - upload
            - download
          description: 操作タイプ（upload または download）
        objects:
          type: array
          minItems: 1
          items:
            $ref: '#/components/schemas/RequestObject'
          description: 処理対象のオブジェクトリスト
        transfers:
          type: array
          items:
            type: string
            enum:
              - basic
          default:
            - basic
          description: |
            転送アダプター（現在は `basic` のみサポート）
        ref:
          $ref: '#/components/schemas/RefInfo'
        hash_algo:
          type: string
          enum:
            - sha256
          default: sha256
          description: ハッシュアルゴリズム（現在は sha256 のみサポート）

    RequestObject:
      type: object
      required:
        - oid
        - size
      properties:
        oid:
          type: string
          pattern: '^[a-f0-9]{64}$'
          description: オブジェクトID（SHA256ハッシュ、64文字の16進数）
          examples:
            - abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890
        size:
          type: integer
          format: int64
          minimum: 1
          description: オブジェクトのバイトサイズ
          examples:
            - 123456789

    RefInfo:
      type: object
      properties:
        name:
          type: string
          description: Git リファレンス名
          examples:
            - refs/heads/main

    BatchResponse:
      type: object
      required:
        - transfer
        - objects
      properties:
        transfer:
          type: string
          enum:
            - basic
          description: 使用する転送アダプター
        objects:
          type: array
          items:
            $ref: '#/components/schemas/ResponseObject'
          description: 処理結果のオブジェクトリスト
        hash_algo:
          type: string
          enum:
            - sha256
          description: ハッシュアルゴリズム

    ResponseObject:
      type: object
      required:
        - oid
        - size
        - authenticated
      properties:
        oid:
          type: string
          pattern: '^[a-f0-9]{64}$'
          description: オブジェクトID
        size:
          type: integer
          format: int64
          description: オブジェクトのバイトサイズ
        authenticated:
          type: boolean
          description: 認証済みかどうか
        actions:
          $ref: '#/components/schemas/Actions'
        error:
          $ref: '#/components/schemas/ObjectError'

    Actions:
      type: object
      properties:
        upload:
          $ref: '#/components/schemas/Action'
        download:
          $ref: '#/components/schemas/Action'

    Action:
      type: object
      required:
        - href
        - expires_in
      properties:
        href:
          type: string
          format: uri
          description: プロキシエンドポイントURL
        header:
          type: object
          additionalProperties:
            type: string
          description: 追加HTTPヘッダー（現在は空）
        expires_in:
          type: integer
          description: URLの有効期限（秒）
          examples:
            - 900

    ObjectError:
      type: object
      required:
        - code
        - message
      properties:
        code:
          type: integer
          description: HTTPステータスコード
          examples:
            - 404
        message:
          type: string
          description: エラーメッセージ
          examples:
            - Object does not exist

    VerifyRequest:
      type: object
      required:
        - oid
        - size
      properties:
        oid:
          type: string
          pattern: '^[a-f0-9]{64}$'
          description: オブジェクトID（SHA256ハッシュ）
        size:
          type: integer
          format: int64
          minimum: 1
          description: オブジェクトのバイトサイズ

    VerifyResponse:
      type: object
      required:
        - message
      properties:
        message:
          type: string
          description: 結果メッセージ
          examples:
            - success

    HealthResponse:
      type: object
      required:
        - status
      properties:
        status:
          type: string
          enum:
            - healthy
          description: サービス稼働状態

    ReadinessResponse:
      type: object
      required:
        - status
        - details
      properties:
        status:
          type: string
          enum:
            - ready
            - not ready
          description: Readiness 状態
        details:
          type: array
          items:
            $ref: '#/components/schemas/ReadinessDetail'
          description: 各依存サービスのヘルスチェック結果

    ReadinessDetail:
      type: object
      required:
        - name
        - healthy
      properties:
        name:
          type: string
          description: ヘルスチェック対象のサービス名
          examples:
            - postgres
            - redis
            - s3
        healthy:
          type: boolean
          description: サービスが正常かどうか
        error:
          type: string
          description: エラーが発生した場合のエラーメッセージ

    ErrorResponse:
      type: object
      properties:
        message:
          type: string
          description: エラーメッセージ
        error:
          type: string
          description: エラー内容（認証系エンドポイント用）
