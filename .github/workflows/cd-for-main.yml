name: CD for Main Branch

on:
  push:
    branches:
      - main

permissions:
  contents: read

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      go-code: ${{ steps.changes.outputs.go-code }}
      e2e-tests: ${{ steps.changes.outputs.e2e-tests }}
      helm-charts: ${{ steps.changes.outputs.helm-charts }}
      docker-images: ${{ steps.changes.outputs.docker-images }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Detect changes
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            go-code:
              - '**/*.go'
              - 'go.mod'
              - 'go.sum'
              - '.golangci.yml'
            e2e-tests:
              - 'e2e/**'
              - 'compose.yml'
              - 'compose.dev.yml'
              - 'compose.ci.yml'
              - 'Dockerfile'
              - '.env.example'
              - 'config/**'
              - 'migrations/**'
              - '**/*.go'
              - 'go.mod'
              - 'go.sum'
            helm-charts:
              - 'helm/**'
            docker-images:
              - 'Dockerfile'
              - 'Dockerfile.migration'
              - '**/*.go'
              - 'go.mod'
              - 'go.sum'
              - 'migrations/**'
              - 'scripts/migrate-goose.sh'

  ci-go:
    needs: detect-changes
    if: needs.detect-changes.outputs.go-code == 'true'
    uses: ./.github/workflows/go-ci.yml
    with:
      working-directory: .
      component-name: cargohold
      timeout-minutes: 30

  e2e-tests:
    needs: detect-changes
    if: needs.detect-changes.outputs.e2e-tests == 'true'
    uses: ./.github/workflows/e2e-test.yml
    with:
      timeout-minutes: 30

  helm-ci:
    needs: detect-changes
    if: needs.detect-changes.outputs.helm-charts == 'true'
    uses: ./.github/workflows/helm-ci.yml
    with:
      helm-chart-path: helm/cargohold
      timeout-minutes: 10

  build-and-push-images:
    needs: [detect-changes, ci-go, e2e-tests, helm-ci]
    if: |
      always() &&
      needs.detect-changes.outputs.docker-images == 'true' &&
      (needs.ci-go.result == 'success' || needs.ci-go.result == 'skipped') &&
      (needs.e2e-tests.result == 'success' || needs.e2e-tests.result == 'skipped') &&
      (needs.helm-ci.result == 'success' || needs.helm-ci.result == 'skipped')
    uses: ./.github/workflows/build-and-push-images.yml
    with:
      image-tag-suffix: ''
      timeout-minutes: 30
    secrets:
      REGISTRY_NA2NA_DEV_BOT_USERNAME: ${{ secrets.REGISTRY_NA2NA_DEV_BOT_USERNAME }}
      REGISTRY_NA2NA_DEV_BOT_KEY: ${{ secrets.REGISTRY_NA2NA_DEV_BOT_KEY }}

  cd-summary:
    runs-on: ubuntu-latest
    needs: [detect-changes, ci-go, e2e-tests, helm-ci, build-and-push-images]
    if: always()
    steps:
      - name: Check CD results
        run: |
          echo "=== CD Summary ==="
          echo "Change detection results:"
          echo "  go-code: ${{ needs.detect-changes.outputs.go-code }}"
          echo "  e2e-tests: ${{ needs.detect-changes.outputs.e2e-tests }}"
          echo "  helm-charts: ${{ needs.detect-changes.outputs.helm-charts }}"
          echo "  docker-images: ${{ needs.detect-changes.outputs.docker-images }}"
          echo ""
          echo "CI results:"
          if [ "${{ needs.detect-changes.outputs.go-code }}" == "true" ]; then
            echo "  go-ci: ${{ needs.ci-go.result }}"
          else
            echo "  go-ci: skipped (no changes)"
          fi
          if [ "${{ needs.detect-changes.outputs.e2e-tests }}" == "true" ]; then
            echo "  e2e-tests: ${{ needs.e2e-tests.result }}"
          else
            echo "  e2e-tests: skipped (no changes)"
          fi
          if [ "${{ needs.detect-changes.outputs.helm-charts }}" == "true" ]; then
            echo "  helm-ci: ${{ needs.helm-ci.result }}"
          else
            echo "  helm-ci: skipped (no changes)"
          fi
          echo ""
          echo "CD results:"
          if [ "${{ needs.detect-changes.outputs.docker-images }}" == "true" ]; then
            echo "  build-and-push-images: ${{ needs.build-and-push-images.result }}"
          else
            echo "  build-and-push-images: skipped (no changes)"
          fi

          if [ "${{ needs.detect-changes.result }}" == "failure" ] || \
             [ "${{ needs.ci-go.result }}" == "failure" ] || \
             [ "${{ needs.e2e-tests.result }}" == "failure" ] || \
             [ "${{ needs.helm-ci.result }}" == "failure" ] || \
             [ "${{ needs.build-and-push-images.result }}" == "failure" ]; then
            echo ""
            echo "One or more jobs failed"
            exit 1
          fi

          echo ""
          echo "All CD processes completed successfully"
