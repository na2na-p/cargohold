name: CI for Pull Requests

on:
  pull_request:
    branches:
      - main
    types:
      - opened
      - reopened
      - synchronize
      - ready_for_review

permissions:
  contents: read
  pull-requests: read

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      go-code: ${{ steps.changes.outputs.go-code }}
      e2e-tests: ${{ steps.changes.outputs.e2e-tests }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Detect changes
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            go-code:
              - '**/*.go'
              - 'go.mod'
              - 'go.sum'
              - '.golangci.yml'
            e2e-tests:
              - 'e2e/**'
              - 'compose.yml'
              - 'Dockerfile'
              - 'config/**'
              - 'migrations/**'
              - '**/*.go'
              - 'go.mod'
              - 'go.sum'

  ci-go:
    needs: detect-changes
    if: needs.detect-changes.outputs.go-code == 'true'
    uses: ./.github/workflows/go-ci.yml
    with:
      working-directory: .
      component-name: cargohold
      timeout-minutes: 30

  e2e-tests:
    needs: detect-changes
    if: needs.detect-changes.outputs.e2e-tests == 'true'
    uses: ./.github/workflows/e2e-test.yml
    with:
      timeout-minutes: 30

  ci-summary:
    runs-on: ubuntu-latest
    needs: [detect-changes, ci-go, e2e-tests]
    if: always()
    steps:
      - name: Check CI results
        run: |
          echo "=== CI Summary ==="
          echo "変更検知結果:"
          echo "  go-code: ${{ needs.detect-changes.outputs.go-code }}"
          echo "  e2e-tests: ${{ needs.detect-changes.outputs.e2e-tests }}"
          echo ""
          echo "CI結果:"
          if [ "${{ needs.detect-changes.outputs.go-code }}" == "true" ]; then
            echo "  go-ci: ${{ needs.ci-go.result }}"
          else
            echo "  go-ci: skipped (変更なし)"
          fi
          if [ "${{ needs.detect-changes.outputs.e2e-tests }}" == "true" ]; then
            echo "  e2e-tests: ${{ needs.e2e-tests.result }}"
          else
            echo "  e2e-tests: skipped (変更なし)"
          fi

          if [ "${{ needs.detect-changes.result }}" == "failure" ] || \
             [ "${{ needs.ci-go.result }}" == "failure" ] || \
             [ "${{ needs.e2e-tests.result }}" == "failure" ]; then
            echo ""
            echo "1つ以上のCIジョブが失敗しました"
            exit 1
          fi

          echo ""
          echo "すべてのCIが正常に完了しました"
