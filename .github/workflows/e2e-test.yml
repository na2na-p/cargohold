name: E2E Tests

on:
  workflow_call:
    inputs:
      timeout-minutes:
        description: "Timeout for E2E tests in minutes"
        required: false
        type: number
        default: 30

env:
  GO_VERSION: "1.25.5"
  COMPOSE_FILE: "compose.yml:compose.dev.yml:compose.ci.yml"

jobs:
  e2e-test:
    runs-on: ubuntu-latest
    timeout-minutes: ${{ inputs.timeout-minutes }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: go.sum

      - name: Verify Go installation
        run: |
          which go
          go version

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker-container

      - name: Install Docker Compose
        run: |
          mkdir -p ~/.docker/cli-plugins
          curl -SL https://github.com/docker/compose/releases/download/v5.0.0/docker-compose-linux-x86_64 -o ~/.docker/cli-plugins/docker-compose
          chmod +x ~/.docker/cli-plugins/docker-compose
          docker compose version

      - name: Setup environment file
        run: |
          cp .env.example .env

      - name: Download Go dependencies
        run: go mod download

      - name: Generate test keys
        run: go run ./cmd/generate-test-keys/

      - name: Start test environment
        run: |
          docker compose up -d --build

      - name: Wait for cargohold application
        run: |
          timeout=120
          elapsed=0
          while ! curl -f http://localhost:8080/readyz > /dev/null 2>&1; do
            if [ $elapsed -ge $timeout ]; then
              echo "Cargohold application startup timed out"
              docker compose logs
              exit 1
            fi
            sleep 2
            elapsed=$((elapsed + 2))
          done
          echo "Cargohold application started successfully (readyz check passed)"

      - name: Check services health
        run: |
          echo "=== Service Status ==="
          docker compose ps

      - name: Run E2E tests
        run: |
          docker compose --profile e2e run --rm e2e-test

      - name: Show test logs on failure
        if: failure()
        run: |
          echo "=== Docker Compose Logs ==="
          docker compose logs

      - name: Cleanup test environment
        if: always()
        run: |
          docker compose down -v
